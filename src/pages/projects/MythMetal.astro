---
import Layout from '../../layout/Layout.astro';

const project = {
  title: "Myth & Metal",
  tagline: "A Minecraft mod that adds tiered loot, procedural dungeons, and custom boss fights—with way too much rendering code.",
  date: "2024",
  role: "Mod Developer & Systems Architect",
  repoUrl: "https://github.com/crowmoed/Myth-Metal---Java",
  stack: ["Java", "Minecraft Forge", "Mixins", "Terrablender", "OpenGL/RenderTypes"]
};

const githubIcon = `
<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.05-.015-2.07-3.345.72-4.05-1.605-4.05-1.605-.54-1.38-1.335-1.755-1.335-1.755-1.095-.75.09-.735.09-.735 1.215.09 1.845 1.245 1.845 1.245 1.08 1.845 2.835 1.305 3.525.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.225 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405 1.02 0 2.04.135 3 .405 2.295-1.545 3.3-1.23 3.3-1.23.66 1.695.24 2.925.12 3.225.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.285 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
</svg>`;
---

<Layout>
  <div class="projects-wrapper back">
    
    <div class="detail-container">
      
      <header class="detail-header fade-in">
        <a href="/projects" class="back-link">
          <span class="arrow">←</span> All Projects
        </a>
        <h1>{project.title}</h1>
        <p class="tagline">{project.tagline}</p>
      </header>

      <div class="content-grid fade-in-delay">
        
        <main class="project-body">
          <div class="project-hero-image">
             <div class="placeholder-overlay">Dungeon Boss Fight with Tier VII Weapon Glint</div>
          </div>

          <div class="text-content">
            <h3>What Is This?</h3>
            <p>
              Myth & Metal overhauls Minecraft's progression with a seven-tier rarity system, procedurally generated dungeons, custom boss fights, and new biomes. The interesting part isn't the features—it's how deep I had to go into Minecraft's internals to make them work.
            </p>
            <p>
              Mixins into the rendering pipeline. Custom world generation via Terrablender. NBT-driven item states. This project showed me that "modding" and "reverse engineering" are pretty much the same thing.
            </p>

            <h3>The Rarity System</h3>
            <p>
              Seven tiers. Damage multipliers from 1.0× up to 5.0×. The key design choice: rarity is stored <strong>per-item</strong>, not per-item-type. Two identical swords can have different tiers. This lives in NBT tags.
            </p>
            <p>
              Making this actually work required Mixins into <code>ItemStack</code>:
            </p>
            <ul>
              <li><strong>Tooltip injection</strong> — <code>@Inject</code> on <code>getTooltipLines</code> appends the rarity display</li>
              <li><strong>Damage calculation</strong> — <code>@Redirect</code> on <code>EnchantmentHelper.getDamageBonus</code> intercepts the damage math and applies tier multipliers before enchantment bonuses</li>
            </ul>
            <p>
              Upgrading items happens at a custom anvil that extends <code>ItemCombinerMenu</code>. Drop in a higher-tier upgrade ingot, and the item inherits that tier.
            </p>

            <h3>Custom Glint Rendering</h3>
            <p>
              This is where things got complicated.
            </p>
            <p>
              Each tier needed its own enchantment glint effect. That meant ~42 custom <code>RenderType</code> instances—7 tiers times 6 variants (basic glint, direct, entity-held, entity-direct, armor, armor-direct). Each one built with <code>RenderType.CompositeState.builder()</code> pointing to tier-specific glint textures.
            </p>
            <p>
              Mixins into <code>ItemRenderer</code> intercept vanilla glint buffer requests and substitute the right render type based on the item's rarity. The armor mixin is more aggressive—it completely replaces <code>render()</code> via <code>@Inject(at = HEAD, cancellable = true)</code>, then manually iterates equipment slots and applies tier-appropriate glints after base armor rendering.
            </p>
            <p>
              I could have used Forge events. Mixins gave me finer control at the cost of more fragile code.
            </p>

            <h3>Procedural Dungeons</h3>
            <p>
              Dungeons are wave-based combat arenas that generate when you first enter a portal. The architecture is weird but effective: <strong>invisible trigger blocks</strong> with <code>BlockEntity</code> instances that manage room state.
            </p>
            <p>
              Here's how a room activates:
            </p>
            <ol>
              <li>Player steps on a trigger block</li>
              <li>Recursive 6-directional flood-fill calculates room boundaries by propagating through adjacent <code>DungeonAirEntity</code> blocks</li>
              <li>Indestructible iron bars (<code>strength = -1.0F</code>) spawn on room edges, trapping the player</li>
              <li>Wave spawning begins—16 mobs total, max 6 alive at once</li>
              <li>When all mobs die, barriers vanish and trigger blocks replace themselves with air</li>
            </ol>
            <p>
              Dungeon mobs extend vanilla counterparts with fire immunity, bonus fire damage, and <code>die()</code> overrides that call back to the room entity. Every mob knows which room it belongs to.
            </p>

            <h3>Generation Algorithm</h3>
            <p>
              When you enter a portal, <code>placedungeon()</code> runs:
            </p>
            <ol>
              <li>Spawn room placed at a unique offset (tracked via <code>SavePortalData</code> to prevent regeneration)</li>
              <li>Loop: randomly pick a room type (tree, nether, bone), place the NBT structure via <code>StructureTemplateManager</code>, add a hallway, advance Z by 17 blocks</li>
              <li>Each iteration has a 10% + (10% × iteration count) chance to stop (capped at 95%)</li>
              <li>Boss room placed at the end</li>
            </ol>
            <p>
              The probabilistic termination creates dungeons with an expected length of ~10 rooms but high variance. Some are short sprints. Some are marathons.
            </p>

            <h3>Boss Fights</h3>
            <p>
              Bosses like Magmaraakh (Lava Dungeon) have animation state machines with timeout counters managing idle/attack transitions. The AI goal stack prioritizes floating, then custom attack behavior, then melee, then movement.
            </p>
            <p>
              The custom attack goal extends <code>MeleeAttackGoal</code> with a 40-tick wind-up before damage lands—synced to the attack animation. Stats are beefy: 550 HP, 25 armor, full knockback resistance. Boss death triggers room completion via a back-reference to <code>DungeonRoomEntity</code>.
            </p>

            <h3>World Generation</h3>
            <p>
              Custom biomes integrate through <strong>Terrablender</strong>, registering overworld regions with weight 4. Each region maps climate parameters to custom biomes:
            </p>
            <ul>
              <li><strong>Ash Forest</strong> — Hot, arid, inland. Surface lava lakes, light-emitting ash logs, magma boulder decorations</li>
              <li><strong>Enchanted Forest</strong> — Ambient <code>ENCHANTED_HIT</code> particles at 0.01f density, custom sound loop, mega jungle-style trees with 2×2 trunks</li>
            </ul>
            <p>
              Tiered ores get progressively rarer: T2 spawns 12 times per chunk across all heights, T7 spawns once per chunk below Y=-16 with triangle distribution. Tree placement uses <code>countExtra(9, 0.5f, 7)</code>—base 9 plus a coin flip for 7 more.
            </p>

            <h3>Dimension System</h3>
            <p>
              The dungeon dimension is registered via Forge's <code>ResourceKey</code> system. Fixed noon lighting, no skylight, zero ambient light, disabled beds. A <code>FixedBiomeSource</code> points to the dungeon biome. Portal blocks handle bidirectional transport with return coordinates stored in player persistent data.
            </p>

            <h3>Patterns I Relied On</h3>
            <ul>
              <li><strong>Deferred Registration</strong> — All blocks, items, and entities use Forge's lazy initialization pattern</li>
              <li><strong>Distributed room state</strong> — Each trigger block has its own BlockEntity, but they share a single <code>DungeonRoomEntity</code> via flood-fill propagation</li>
              <li><strong>NBT persistence</strong> — Room state survives world saves via <code>saveAdditional()</code>/<code>load()</code></li>
              <li><strong>Structure composition</strong> — Dungeons are multiple NBT structures placed sequentially along Z</li>
            </ul>
          </div>
        </main>

        <aside class="project-sidebar">
          
          <div class="meta-block">
            <span class="meta-label">Role</span>
            <span class="meta-value">{project.role}</span>
          </div>

          <div class="meta-block">
            <span class="meta-label">Timeline</span>
            <span class="meta-value">{project.date}</span>
          </div>

          <div class="meta-block">
            <span class="meta-label">Stack</span>
            <div class="tech-stack-wrap">
              {project.stack.map(tech => (
                <span class="tech-tag">{tech}</span>
              ))}
            </div>
          </div>

          <div class="meta-block">
            <span class="meta-label">Systems</span>
            <div class="tech-stack-wrap">
              <span class="tech-tag">7-Tier Rarity</span>
              <span class="tech-tag">Procedural Dungeons</span>
              <span class="tech-tag">Custom Glints</span>
              <span class="tech-tag">Boss AI</span>
              <span class="tech-tag">Biomes</span>
            </div>
          </div>

          <div class="meta-block">
            <span class="meta-label">Mixins</span>
            <span class="meta-value">ItemStack, ItemRenderer, HumanoidArmorLayer, RenderBuffers</span>
          </div>

          <div class="meta-block">
            <span class="meta-label">RenderTypes</span>
            <span class="meta-value">~42 custom instances</span>
          </div>

          <div class="meta-block">
            <span class="meta-label">Damage Scaling</span>
            <span class="meta-value">1.0× → 5.0× across tiers</span>
          </div>

          <div class="action-buttons">
            <a href={project.repoUrl} target="_blank" class="action-btn outline">
              <span class="icon" set:html={githubIcon} />
              View Code
            </a>
          </div>

        </aside>

      </div>

    </div>
  </div>
</Layout>